<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RocketMQ | Emil`s Blog</title><meta name="keywords" content="mq"><meta name="author" content="Emil"><meta name="copyright" content="Emil"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="RocketMQ简介 RocketMQ是一个纯Java、分布式、队列模型的开源消息中间件，前身是MetaQ，是阿里参考Kafka特点研发的一个队列模型的消息中间件，后开源给apache基金会成为了apache的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。    RocketMQ的心路历程  2007年：淘宝实施了“五彩石”项目，“五彩石”用于将交易系统从单机变成分布式，也是在这个过程中"><meta property="og:type" content="article"><meta property="og:title" content="RocketMQ"><meta property="og:url" content="https://blog.hvnobug.com/post/rocketmq.html"><meta property="og:site_name" content="Emil&#96;s Blog"><meta property="og:description" content="RocketMQ简介 RocketMQ是一个纯Java、分布式、队列模型的开源消息中间件，前身是MetaQ，是阿里参考Kafka特点研发的一个队列模型的消息中间件，后开源给apache基金会成为了apache的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。    RocketMQ的心路历程  2007年：淘宝实施了“五彩石”项目，“五彩石”用于将交易系统从单机变成分布式，也是在这个过程中"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/38.png"><meta property="article:published_time" content="2020-08-03T06:19:53.000Z"><meta property="article:modified_time" content="2021-04-29T03:35:56.980Z"><meta property="article:author" content="Emil"><meta property="article:tag" content="mq"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/38.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/hvnobug/assets/common/favicon.ico"><link rel="canonical" href="https://blog.hvnobug.com/post/rocketmq"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin="crossorigin"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/pwa/manifest.json"><meta name="msapplication-TileColor" content="#fff"><link rel="apple-touch-icon" sizes="180x180" href="/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/pwa/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/pwa/16.png"><link rel="mask-icon" href="/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?39cbf1602bb584a9c817fbe7b061c842";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-153501439-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-153501439-1")</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-04-29 11:35:56"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><style type="text/css">.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><style type="text/css">.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap span{color:#fff;text-decoration:underline;cursor:pointer}.snackbar-pos.bottom-left{bottom:70px}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Emil`s Blog" type="application/atom+xml"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/common/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">56</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">34</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">32</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 统计</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/album/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fa fa-book"></i><span> 书籍</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fa fa-gamepad"></i><span> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/nav/"><i class="fa-fw fa fa-map"></i><span> 网址导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/38.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Emil`s Blog</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 统计</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/album/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fa fa-book"></i><span> 书籍</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fa fa-gamepad"></i><span> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/friends/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/nav/"><i class="fa-fw fa fa-map"></i><span> 网址导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">RocketMQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-03T06:19:53.000Z" title="发表于 2020-08-03 14:19:53">2020-08-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-29T03:35:56.980Z" title="更新于 2021-04-29 11:35:56">2021-04-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mq/">mq</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="rocketmq简介"><a class="markdownIt-Anchor" href="#rocketmq简介"></a> RocketMQ简介</h2><div class="note info flat"><p><code>RocketMQ</code>是一个纯<code>Java</code>、<strong>分布式</strong>、<strong>队列模型</strong>的开源消息中间件，前身是<code>MetaQ</code>，是阿里参考<code>Kafka</code>特点研发的一个队列模型的消息中间件，后开源给<code>apache</code>基金会成为了<code>apache</code>的顶级开源项目，具有<strong>高性能</strong>、<strong>高可靠</strong>、<strong>高实时</strong>、<strong>分布式</strong>特点。</p></div><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/rocket.gif" alt=""></p><h2 id="rocketmq的心路历程"><a class="markdownIt-Anchor" href="#rocketmq的心路历程"></a> RocketMQ的心路历程</h2><ul><li><strong>2007年</strong>：淘宝实施了“五彩石”项目，“五彩石”用于将交易系统从单机变成分布式，也是在这个过程中产生了阿里巴巴第一代消息引擎——<code>Notify</code>。</li><li><strong>2010年</strong>：阿里巴巴<code>B2B</code>部门基于<code>ActiveMQ</code>的5.1版本也开发了自己的一款消息引擎，称为<code>Napoli</code>，这款消息引擎在<code>B2B</code>里面广泛地被使用，不仅仅是在交易领域，在很多的后台异步解耦等方面也得到了广泛的应用。</li><li><strong>2011年</strong>：业界出现了现在被很多大数据领域所推崇的<code>Kafka</code>消息引擎，阿里巴巴在研究了<code>Kafka</code>的整体机制和架构设计之后，基于<code>Kafka</code>的设计使用<code>Java</code>进行了完全重写并推出了<strong>MetaQ 1.0</strong>版本，主要是用于解决顺序消息和海量堆积的问题。</li><li><strong>2012年</strong>：阿里巴巴开源其自研的第三代分布式消息中间件——<code>RocketMQ</code>。<br>经过几年的技术打磨，阿里称基于<code>RocketMQ</code>技术，目前双十一当天消息容量可达到万亿级。</li><li><strong>2016年11月</strong>：阿里将<code>RocketMQ</code>捐献给<code>Apache</code>软件基金会，正式成为孵化项目。<br>阿里称会将其打造成顶级项目。这是阿里迈出的一大步，因为加入到开源软件基金会需要经过评审方的考核与观察。<br>坦率而言，业界还对国人的代码开源参与度仍保持着刻板印象；而<code>Apache</code>基金会中的342个项目中，暂时还只有<code>Kylin</code>、<code>CarbonData</code>、<code>Eagle</code> 、<code>Dubbo</code>和 <code>RocketMQ</code> 共计五个中国技术人主导的项目。</li><li><strong>2017年2月20日</strong>：<code>RocketMQ</code>正式发布4.0版本，专家称新版本适用于电商领域，金融领域，大数据领域，兼有物联网领域的编程模型。<br>以上就是<code>RocketMQ</code>的整体发展历史，其实在阿里巴巴内部围绕着<code>RocketMQ</code>内核打造了三款产品，分别是<code>MetaQ</code>、<code>Notify</code>和<code>Aliware MQ</code>。<br>这三者分别采用了不同的模型，<code>MetaQ</code>主要使用了拉模型，解决了顺序消息和海量堆积问题；<code>Notify</code>主要使用了推模型，解决了事务消息；而云产品<code>Aliware MQ</code>则是提供了商业化的版本。</li></ul><h2 id="rocketmq的特性"><a class="markdownIt-Anchor" href="#rocketmq的特性"></a> RocketMQ的特性</h2><ul><li>发布/订阅消息传递模型</li><li>财务级交易消息</li><li>各种跨语言客户端，例如<code>Java</code>，<code>C / C ++</code>，<code>Python</code>，<code>Go</code></li><li>可插拔的传输协议，例如<code>TCP</code>，<code>SSL</code>，<code>AIO</code></li><li>内置的消息跟踪功能，还支持开放式跟踪</li><li>多功能的大数据和流生态系统集成</li><li>按时间或偏移量追溯消息</li><li>可靠的<code>FIFO</code>和严格的有序消息传递在同一队列中</li><li>高效的推拉消费模型</li><li>单个队列中的百万级消息累积容量</li><li>多种消息传递协议，例如<code>JMS</code>和<code>OpenMessaging</code></li><li>灵活的分布式横向扩展部署架构</li><li>快如闪电的批量消息交换系统</li><li>各种消息过滤器机制，例如<code>SQL</code>和<code>Tag</code></li><li>用于隔离测试和云隔离群集的<code>Docker</code>映像</li><li>功能丰富的管理仪表板，用于配置，指标和监视</li><li>认证与授权</li></ul><h2 id="rocketmq的项目结构"><a class="markdownIt-Anchor" href="#rocketmq的项目结构"></a> RocketMQ的项目结构</h2><blockquote><p>GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq">https://github.com/apache/rocketmq</a></p></blockquote><h2 id="rocketmq的核心模块"><a class="markdownIt-Anchor" href="#rocketmq的核心模块"></a> RocketMq的核心模块</h2><ul><li><strong>rocketmq-broker</strong>：接受生产者发来的消息并存储（通过调用<strong>rocketmq-store</strong>），消费者从这里取得消息</li><li><strong>rocketmq-client</strong>：提供发送、接受消息的客户端<code>API</code>。</li><li><strong>rocketmq-namesrv</strong>：<code>NameServer</code>，类似于<code>Zookeeper</code>，这里保存着消息的<code>TopicName</code>，队列等运行时的元信息。</li><li><strong>rocketmq-common</strong>：通用的一些类，方法，数据结构等。</li><li><strong>rocketmq-remoting</strong>：基于<code>Netty4</code>的<code>client/server</code> + <code>fastjson</code>序列化 + 自定义二进制协议。</li><li><strong>rocketmq-store</strong>：消息、索引存储等。</li><li><strong>rocketmq-filtersrv</strong>：消息过滤器<code>Server</code>，需要注意的是，要实现这种过滤，需要上传代码到<code>MQ</code>！（一般而言，我们利用Tag足以满足大部分的过滤需求，如果更灵活更复杂的过滤需求，可以考虑<code>filtersrv</code>组件）。</li><li><strong>rocketmq-tools</strong>：命令行工具。</li></ul><h2 id="rocketmq的架构"><a class="markdownIt-Anchor" href="#rocketmq的架构"></a> RocketMQ的架构</h2><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/rocket-architecture-diagram.jpg" alt=""></p><div class="note orange icon flat"><i class="note-icon fas fa-bullhorn"></i><p>我们可以看到<code>RocketMQ</code>啥都是集群部署的，这是他吞吐量大，高可用的原因之一，集群的模式也很花哨，可以支持多<code>master</code> 模式、多<code>master</code>多<code>slave</code>异步复制模式、多 <code>master</code>多<code>slave</code>同步双写模式。</p></div><h3 id="nameserver"><a class="markdownIt-Anchor" href="#nameserver"></a> NameServer</h3><blockquote><p>主要负责对于源数据的管理，包括了对于<code>Topic</code>和路由信息的管理。</p></blockquote><ul><li><p><code>NameServer</code>是一个功能齐全的服务器，其角色类似<code>Dubbo</code>中的<code>Zookeeper</code>，但<code>NameServer</code>与<code>Zookeeper</code>相比更轻量。主要是因为每个<code>NameServer</code>节点互相之间是独立的，没有任何信息交互。</p></li><li><p><code>NameServer</code>压力不会太大，平时主要开销是在维持心跳和提供<code>Topic-Broker</code>的关系数据。</p></li></ul><blockquote><p>但有一点需要注意，<code>Broker</code>向<code>NameServer</code>发心跳时， 会带上当前自己所负责的所有<code>Topic</code>信息，如果<code>Topic</code>个数太多（万级别），会导致一次心跳中，就<code>Topic</code>的数据就几十M，网络情况差的话， 网络传输失败，心跳失败，导致<code>NameServer</code>误认为<code>Broker</code>心跳失败。</p></blockquote><ul><li><code>NameServer</code>被设计成几乎无状态的，可以横向扩展，节点之间相互之间无通信，通过部署多台机器来标记自己是一个伪集群。</li></ul><blockquote><p>每个 Broker 在启动的时候会到 <code>NameServer</code> 注册，<code>Producer</code> 在发送消息前会根据 <code>Topic</code> 到 <code>NameServer</code> 获取到 <code>Broker</code> 的路由信息，<code>Consumer</code> 也会定时获取 <code>Topic</code> 的路由信息。<br>所以从功能上看<code>NameServer</code>应该是和 <code>ZooKeeper</code> 差不多，据说 <code>RocketMQ</code> 的早期版本确实是使用的 <code>ZooKeeper</code> ，后来改为了自己实现的 <code>NameServer</code> 。<br>我们看一下<code>Dubbo</code>中注册中心的角色，是不是真的一毛一样，师出同门相似点真的很多：</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/dubbo.png" alt=""></p><h3 id="producer"><a class="markdownIt-Anchor" href="#producer"></a> Producer</h3><blockquote><p>消息生产者，负责产生消息，一般由业务系统负责产生消息。</p></blockquote><ul><li><code>Producer</code>由用户进行分布式部署，消息由<code>Producer</code>通过多种负载均衡模式发送到<code>Broker</code>集群，发送低延时，支持快速失败。</li><li><code>RocketMQ</code> 提供了三种方式发送消息：同步、异步和单向</li><li><code>同步发送</code>：同步发送指消息发送方发出数据后会在收到接收方发回响应之后才发下一个数据包。一般用于重要通知消息，例如重要通知邮件、营销短信。</li><li><code>异步发送</code>：异步发送指发送方发出数据后，不等接收方发回响应，接着发送下个数据包，一般用于可能链路耗时较长而对响应时间敏感的业务场景，例如用户视频上传后通知启动转码服务。</li><li><code>单向发送</code>：单向发送是指只负责发送消息而不等待服务器回应且没有回调函数触发，适用于某些耗时非常短但对可靠性要求并不高的场景，例如日志收集。</li></ul><h3 id="broker"><a class="markdownIt-Anchor" href="#broker"></a> Broker</h3><blockquote><p>消息中转角色，负责<strong>存储消息</strong>，<strong>转发消息</strong>。</p></blockquote><ul><li><code>Broker</code>是具体提供业务的服务器，单个<code>Broker</code>节点与所有的<code>NameServer</code>节点保持长连接及心跳，并会定时将<code>Topic</code>信息注册到NameServer，顺带一提底层的通信和连接都是基于Netty实现的。</li><li><code>Broker</code>负责消息存储，以<code>Topic</code>为纬度支持轻量级的队列，单机可以支撑上万队列规模，支持消息推拉模型。</li><li>官网上有数据显示：具有上亿级消息堆积能力，同时可严格保证消息的有序性。</li></ul><h3 id="consumer"><a class="markdownIt-Anchor" href="#consumer"></a> Consumer</h3><blockquote><p>消息消费者，负责消费消息，一般是后台系统负责异步消费。</p></blockquote><ul><li><code>Consumer</code>也由用户部署，支持PUSH和PULL两种消费模式，支持<strong>集群消费</strong>和<strong>广播消息</strong>，提供实时的消息订阅机制。</li><li><code>Pull</code>：拉取型消费者（Pull Consumer）主动从消息服务器拉取信息，只要批量拉取到消息，用户应用就会启动消费过程，所以 Pull 称为主动消费型。</li><li><code>Push</code>：推送型消费者（Push Consumer）封装了消息的拉取、消费进度和其他的内部维护工作，将消息到达时执行的回调接口留给用户应用程序来实现。所以 Push 称为被动消费类型，但从实现上看还是从消息服务器中拉取消息，不同于 Pull 的是 Push 首先要注册消费监听器，当监听器处触发后才开始消费消息。</li></ul><h2 id="消息领域模型"><a class="markdownIt-Anchor" href="#消息领域模型"></a> 消息领域模型</h2><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/message-domain-model.png" alt=""></p><h3 id="message"><a class="markdownIt-Anchor" href="#message"></a> Message</h3><blockquote><p><code>Message</code>（消息）就是要传输的信息。</p></blockquote><p>一条消息必须有一个主题（<code>Topic</code>），主题可以看做是你的信件要邮寄的地址。</p><p>一条消息也可以拥有一个可选的标签（<code>Tag</code>）和额处的键值对，它们可以用于设置一个业务 <code>Key</code> 并在 <code>Broker</code> 上查找此消息以便在开发期间查找问题。</p><h3 id="topic"><a class="markdownIt-Anchor" href="#topic"></a> Topic</h3><p><code>Topic</code>（主题）可以看做消息的规类，它是消息的第一级类型。比如一个电商系统可以分为：交易消息、物流消息等，一条消息必须有一个 Topic 。<br><code>Topic</code> 与生产者和消费者的关系非常松散，一个 <code>Topic</code> 可以有0个、1个、多个生产者向其发送消息，一个生产者也可以同时向不同的 Topic 发送消息。<br>一个 <code>Topic</code> 也可以被 0个、1个、多个消费者订阅。</p><h3 id="tag"><a class="markdownIt-Anchor" href="#tag"></a> Tag</h3><p><code>Tag</code>（标签）可以看作子主题，它是消息的第二级类型，用于为用户提供额外的灵活性。使用标签，同一业务模块不同目的的消息就可以用相同 <code>Topic</code> 而不同的 <code>Tag</code> 来标识。比如交易消息又可以分为：交易创建消息、交易完成消息等，一条消息可以没有 <code>Tag</code> 。</p><p>标签有助于保持您的代码干净和连贯，并且还可以为 <code>RocketMQ</code> 提供的查询系统提供帮助。</p><h3 id="group"><a class="markdownIt-Anchor" href="#group"></a> Group</h3><blockquote><p>分组，一个组可以订阅多个<code>Topic</code>。</p></blockquote><p>分为<code>ProducerGroup</code>，<code>ConsumerGroup</code>，代表某一类的生产者和消费者，一般来说同一个服务可以作为<code>Group</code>，同一个<code>Group</code>一般来说发送和消费的消息都是一样的</p><h3 id="queue"><a class="markdownIt-Anchor" href="#queue"></a> Queue</h3><p>在<code>Kafka</code>中叫<code>Partition</code>，每个<code>Queue</code>内部是有序的，在<code>RocketMQ</code>中分为读和写两种队列，一般来说读写队列数量一致，如果不一致就会出现很多问题。</p><h3 id="message-queue"><a class="markdownIt-Anchor" href="#message-queue"></a> Message Queue</h3><blockquote><p><code>Message Queue</code>（消息队列），主题被划分为一个或多个子主题，即消息队列。</p></blockquote><p>一个 <code>Topic</code> 下可以设置多个消息队列，发送消息时执行该消息的 <code>Topic</code> ，<code>RocketMQ</code> 会轮询该 <code>Topic</code> 下的所有队列将消息发出去。<br>消息的物理管理单位。一个<code>Topic</code>下可以有多个<code>Queue</code>，<code>Queue</code>的引入使得消息的存储可以分布式集群化，具有了水平扩展能力。</p><h3 id="offset"><a class="markdownIt-Anchor" href="#offset"></a> Offset</h3><p>在<code>RocketMQ</code> 中，所有消息队列都是持久化，长度无限的数据结构，所谓长度无限是指队列中的每个存储单元都是定长，访问其中的存储单元使用Offset 来访问，<code>Offset</code> 为 java long 类型，64 位，理论上在 100年内不会溢出，所以认为是长度无限。<br>也可以认为 <code>Message Queue</code> 是一个长度无限的数组，<code>Offset</code> 就是下标。</p><h3 id="消息消费模式"><a class="markdownIt-Anchor" href="#消息消费模式"></a> 消息消费模式</h3><blockquote><p>消息消费模式有两种：<code>Clustering</code>（集群消费）和<code>Broadcasting</code>（广播消费）。</p></blockquote><p>默认情况下就是集群消费，该模式下一个消费者集群共同消费一个主题的多个队列，一个队列只会被一个消费者消费，如果某个消费者挂掉，分组内其它消费者会接替挂掉的消费者继续消费。</p><p>而广播消费消息会发给消费者组中的每一个消费者进行消费。</p><h3 id="message-order"><a class="markdownIt-Anchor" href="#message-order"></a> Message Order</h3><blockquote><p><code>Message Order</code>（消息顺序）有两种：<code>Orderly</code>（顺序消费）和<code>Concurrently</code>（并行消费）。</p></blockquote><p>顺序消费表示消息消费的顺序同生产者为每个消息队列发送的顺序一致，所以如果正在处理全局顺序是强制性的场景，需要确保使用的主题只有一个消息队列。</p><p>并行消费不再保证消息顺序，消费的最大并行数量受每个消费者客户端指定的线程池限制。</p><h2 id="一次完整的通信流程"><a class="markdownIt-Anchor" href="#一次完整的通信流程"></a> 一次完整的通信流程</h2><p><code>Producer</code> 与 <code>NameServer</code>集群中的其中一个节点（随机选择）建立长连接，定期从 <code>NameServer</code> 获取 <code>Topic</code> 路由信息，并向提供 <code>Topic</code> 服务的 <code>Broker Master</code> 建立长连接，且定时向 <code>Broker</code> 发送心跳。</p><p><code>Producer</code> 只能将消息发送到 <code>Broker master</code>，但是 <code>Consumer</code> 则不一样，它同时和提供 <code>Topic</code> 服务的 <code>Master</code> 和 <code>Slave</code>建立长连接，既可以从 <code>Broker Master</code> 订阅消息，也可以从<code>Broker Slave</code> 订阅消息。</p><h3 id="nameservice启动流程"><a class="markdownIt-Anchor" href="#nameservice启动流程"></a> NameService启动流程</h3><p>在<code>org.apache.rocketmq.namesrv</code>目录下的<code>NamesrvStartup</code>这个启动类基本上描述了他的启动过程我们可以看一下代码：</p><ul><li>第一步是初始化配置</li><li>创建<code>NamesrvController</code>实例，并开启两个定时任务：</li><li>每隔10s扫描一次<code>Broker</code>，移除处于不激活的<code>Broker</code>；</li><li>每隔10s打印一次<code>KV</code>配置。<br><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/nameserver-code.png" alt=""></li><li>第三步注册钩子函数，启动服务器并监听<code>Broker</code>。</li></ul><p><code>NameService</code>还有很多东西的哈我这里就介绍他的启动流程，大家还可以去看看代码，还是很有意思的，比如路由注册会发送心跳包，还有心跳包的处理流程，路由删除，路由发现等等。</p><h3 id="producer-2"><a class="markdownIt-Anchor" href="#producer-2"></a> Producer</h3><p><code>Producer</code>是消息发送方，那他怎么发送的呢？</p><p>通过轮训，<code>Producer</code>轮训某个<code>Topic</code>下面的所有队列实现发送方的负载均衡</p><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/producer-img.png" alt=""></p><h3 id="broker-2"><a class="markdownIt-Anchor" href="#broker-2"></a> Broker</h3><p><code>Broker</code>在<code>RocketMQ</code>中是进行处理<code>Producer</code>发送消息请求，<code>Consumer</code>消费消息的请求，并且进行消息的持久化，以及<code>HA</code>策略和服务端过滤，就是集群中很重的工作都是交给了<code>Broker</code>进行处理。</p><p><code>Broker</code>模块是通过<code>BrokerStartup</code>进行启动的，会实例化<code>BrokerController</code>，并且调用其初始化方法</p><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/broker-code.png" alt=""></p><p>大家去看<code>Broker</code>的源码的话会发现，他的初始化流程很冗长，会根据配置创建很多线程池主要用来发送消息、拉取消息、查询消息、客户端管理和消费者管理，也有很多定时任务，同时也注册了很多请求处理器，用来发送拉取消息查询消息的。</p><h3 id="consumer-2"><a class="markdownIt-Anchor" href="#consumer-2"></a> Consumer</h3><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/consumer-img.png" alt=""></p><p>消费端会通过<code>RebalanceService</code>线程，10秒钟做一次基于<code>Topic</code>下的所有队列负载。</p><h2 id="rocketmq优缺点"><a class="markdownIt-Anchor" href="#rocketmq优缺点"></a> RocketMq优缺点</h2><p>RocketMQ优点:</p><ol><li>单机吞吐量：十万级</li><li>可用性：非常高，分布式架构</li><li>消息可靠性：经过参数优化配置，消息可以做到0丢失</li><li>功能支持：MQ功能较为完善，还是分布式的，扩展性好</li><li>支持10亿级别的消息堆积，不会因为堆积导致性能下降</li><li>源码是java，我们可以自己阅读源码，定制自己公司的MQ，可以掌控</li><li>天生为金融互联网领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况</li><li><code>RoketMQ</code>在稳定性上可能更值得信赖，这些业务场景在阿里双11已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择RocketMQ</li></ol><p>RocketMQ缺点:</p><ol><li>支持的客户端语言不多，目前是<code>java</code>及<code>c++</code>，其中<code>c++</code>不成熟</li><li>社区活跃度不是特别活跃那种</li><li>没有在 <code>mq</code> 核心中去实现<code>JMS</code>等接口，有些系统要迁移需要修改大量代码</li></ol><h2 id="rocketmq消息去重"><a class="markdownIt-Anchor" href="#rocketmq消息去重"></a> RocketMq消息去重</h2><p><strong>去重原则</strong>：使用业务端逻辑保持幂等性</p><p><strong>幂等性</strong>：就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用，数据库的结果都是唯一的，不可变的。<br>只要保持幂等性，不管来多少条重复消息，最后处理的结果都一样，需要业务端来实现。</p><p><strong>去重策略</strong>：保证每条消息都有唯一编号(比如唯一流水号)，且保证消息处理成功与去重表的日志同时出现。<br>建立一个消息表，拿到这个消息做数据库的insert操作。给这个消息做一个唯一主键（primary key）或者唯一约束，那么就算出现重复消费的情况，就会导致主键冲突，那么就不再处理这条消息。</p><h2 id="rocketmq消息重复"><a class="markdownIt-Anchor" href="#rocketmq消息重复"></a> RocketMq消息重复</h2><p>消息领域有一个对消息投递的QoS定义，分为：</p><ul><li>最多一次（At most once）</li><li>至少一次（At least once）</li><li>仅一次（ Exactly once）</li></ul><blockquote><p>QoS：Quality of Service，服务质量</p></blockquote><p>几乎所有的<code>MQ</code>产品都声称自己做到了<code>At least once</code>。<br>既然是至少一次，那避免不了消息重复，尤其是在分布式网络环境下。<br>比如：网络原因闪断，<code>ACK</code>返回失败等等故障，确认信息没有传送到消息队列，导致消息队列不知道自己已经消费过该消息了，再次将该消息分发给其他的消费者。<br>不同的消息队列发送的确认信息形式不同，例如<code>RabbitMQ</code>是发送一个<code>ACK</code>确认消息，<code>RocketMQ</code>是返回一个<code>CONSUME_SUCCESS</code>成功标志，<code>Kafka</code>实际上有个<code>offset</code>的概念。<br><code>RocketMQ</code>没有内置消息去重的解决方案，最新版本是否支持还需确认。</p><h2 id="rocketmq消息的可用性"><a class="markdownIt-Anchor" href="#rocketmq消息的可用性"></a> RocketMq消息的可用性</h2><p>当我们选择好了集群模式之后，那么我们需要关心的就是怎么去存储和复制这个数据，<code>RocketMQ</code>对消息的刷盘提供了同步和异步的策略来满足我们的，当我们选择同步刷盘之后，如果刷盘超时会给返回<code>FLUSH_DISK_TIMEOUT</code>，如果是异步刷盘不会返回刷盘相关信息，选择同步刷盘可以尽最大程度满足我们的消息不会丢失。<br>除了存储有选择之后，我们的主从同步提供了同步和异步两种模式来进行复制，当然选择同步可以提升可用性，但是消息的发送RT时间会下降10%左右。<br><code>RocketMQ</code>采用的是混合型的存储结构，即为<code>Broker</code>单个实例下所有的队列共用一个日志数据文件（即为<code>CommitLog</code>）来存储。<br>而<code>Kafka</code>采用的是独立型的存储结构，每个队列一个文件。<br>这里帅丙认为，<code>RocketMQ</code>采用混合型存储结构的缺点在于，会存在较多的随机读操作，因此读的效率偏低。同时消费消息需要依赖ConsumeQueue，构建该逻辑消费队列需要一定开销。</p><h2 id="rocketmq刷盘实现"><a class="markdownIt-Anchor" href="#rocketmq刷盘实现"></a> RocketMq刷盘实现</h2><p><code>Broker</code> 在消息的存取时直接操作的是内存（内存映射文件），这可以提供系统的吞吐量，但是无法避免机器掉电时数据丢失，所以需要持久化到磁盘中。<br>刷盘的最终实现都是使用<code>NIO</code>中的 <code>MappedByteBuffer.force()</code> 将映射区的数据写入到磁盘，如果是同步刷盘的话，在<code>Broker</code>把消息写到<code>CommitLog</code>映射区后，就会等待写入完成。<br>异步而言，只是唤醒对应的线程，不保证执行的时机，流程如图所示。</p><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/rocket-wirte-disk.png" alt=""></p><h2 id="rocketmq顺序消息"><a class="markdownIt-Anchor" href="#rocketmq顺序消息"></a> RocketMq顺序消息</h2><p>生产者消费者一般需要保证顺序消息的话，可能就是一个业务场景下的，比如订单的创建、支付、发货、收货。<br>那这些东西是不是一个订单号呢？一个订单的肯定是一个订单号的说，那简单了呀。<br>一个<code>topic</code>下有多个队列，为了保证发送有序，<code>RocketMQ</code>提供了<code>MessageQueueSelector</code>队列选择机制，他有三种实现:</p><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/message-queue-selector.png" alt=""></p><p>我们可使用<code>Hash</code>取模法，让同一个订单发送到同一个队列中，再使用同步发送，只有同个订单的创建消息发送成功，再发送支付消息。这样，我们保证了发送有序。<br><code>RocketMQ</code>的<code>topic</code>内的队列机制,可以保证存储满足<strong>FIFO</strong>（<code>First Input First Output</code> 简单说就是指先进先出）,剩下的只需要消费者顺序消费即可。<br><code>RocketMQ</code>仅保证顺序发送，顺序消费由消费者业务保证!!!<br>这里很好理解，一个订单你发送的时候放到一个队列里面去，你同一个的订单号Hash一下是不是还是一样的结果，那肯定是一个消费者消费，那顺序是不是就保证了？<br>真正的顺序消费不同的中间件都有自己的不同实现我这里就举个例子，大家思路理解下。</p><h2 id="rocketmq分布式事务"><a class="markdownIt-Anchor" href="#rocketmq分布式事务"></a> RocketMq分布式事务</h2><h3 id="half-message半消息"><a class="markdownIt-Anchor" href="#half-message半消息"></a> Half Message(半消息)</h3><p>是指暂不能被<code>Consumer</code>消费的消息。<code>Producer</code> 已经把消息成功发送到了 <code>Broker</code> 端，但此消息被标记为暂不能投递状态，处于该种状态下的消息称为半消息。需要 <code>Producer</code></p><p>对消息的<strong>二次确认</strong>后，<code>Consumer</code>才能去消费它。</p><h3 id="消息回查"><a class="markdownIt-Anchor" href="#消息回查"></a> 消息回查</h3><p>由于网络闪段，生产者应用重启等原因。导致 <code>Producer</code> 端一直没有对 <code>Half Message</code>(半消息) 进行 二次确认。这是<code>Brock</code>服务器会定时扫描长期处于半消息的消息，会<br>主动询问 <code>Producer</code>端 该消息的最终状态(<code>Commit</code>或者<code>Rollback</code>),该消息即为 消息回查。</p><p><img src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/loading/11.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/post/images/rocket-message-recheck.png" alt=""></p><ol><li>A服务先发送个<code>Half Message</code>给<code>Brock</code>端，消息中携带 B服务 即将要+100元的信息。</li><li>当A服务知道<code>Half Message</code>发送成功后，那么开始第3步执行本地事务。</li><li>执行本地事务(会有三种情况1、执行成功。2、执行失败。3、网络等原因导致没有响应)</li><li>如果本地事务成功，那么<code>Product</code>像<code>Brock</code>服务器发送<code>Commit</code>,这样B服务就可以消费该<code>message</code>。</li><li>如果本地事务失败，那么<code>Product</code>像<code>Brock</code>服务器发送<code>Rollback</code>,那么就会直接删除上面这条半消息。</li><li>如果因为网络等原因迟迟没有返回失败还是成功，那么会执行<code>RocketMQ</code>的回调接口,来进行事务的回查。</li></ol><h2 id="rocketmq消息过滤"><a class="markdownIt-Anchor" href="#rocketmq消息过滤"></a> RocketMq消息过滤</h2><ul><li><code>Broker</code>端消息过滤  在<code>Broker</code>中，按照<code>Consumer</code>的要求做过滤，优点是减少了对于<code>Consumer</code>无用消息的网络传输。缺点是增加了<code>Broker</code>的负担，实现相对复杂。</li><li><code>Consumer</code>端消息过滤这种过滤方式可由应用完全自定义实现，但是缺点是很多无用的消息要传输到<code>Consumer</code>端。</li></ul><h2 id="broker的buffer问题"><a class="markdownIt-Anchor" href="#broker的buffer问题"></a> Broker的Buffer问题</h2><p><code>Broker</code>的<code>Buffer</code>通常指的是<code>Broker</code>中一个队列的内存<code>Buffer</code>大小，这类<code>Buffer</code>通常大小有限。</p><p>另外，<code>RocketMQ</code>没有内存<code>Buffer</code>概念，<code>RocketMQ</code>的队列都是持久化磁盘，数据定期清除。</p><p><code>RocketMQ</code>同其他MQ有非常显著的区别，<code>RocketMQ</code>的内存<code>Buffer</code>抽象成一个无限长度的队列，不管有多少数据进来都能装得下，这个无限是有前提的，Broker会定期删除过期的数据。</p><p>例如<code>Broker</code>只保存3天的消息，那么这个<code>Buffer</code>虽然长度无限，但是3天前的数据会被从队尾删除。</p><h2 id="rocketmq回溯消费"><a class="markdownIt-Anchor" href="#rocketmq回溯消费"></a> RocketMq回溯消费</h2><p>回溯消费是指<code>Consumer</code>已经消费成功的消息，由于业务上的需求需要重新消费，要支持此功能，<code>Broker</code>在向<code>Consumer</code>投递成功消息后，消息仍然需要保留。并且重新消费一般是按照时间维度。<br>例如由于<code>Consumer</code>系统故障，恢复后需要重新消费1小时前的数据，那么<code>Broker</code>要提供一种机制，可以按照时间维度来回退消费进度。<br><code>RocketMQ</code>支持按照时间回溯消费，时间维度精确到毫秒，可以向前回溯，也可以向后回溯。</p><h2 id="rocketmq消息堆积"><a class="markdownIt-Anchor" href="#rocketmq消息堆积"></a> RocketMq消息堆积</h2><blockquote><p>消息中间件的主要功能是异步解耦，还有个重要功能是挡住前端的数据洪峰，保证后端系统的稳定性，这就要求消息中间件具有一定的消息堆积能力，消息堆积分以下两种情况：</p></blockquote><ul><li>消息堆积在内存<code>Buffer</code>，一旦超过内存<code>Buffer</code>，可以根据一定的丢弃策略来丢弃消息，如CORBA Notification规范中描述。适合能容忍丢弃消息的业务，这种情况消息的堆积能力主要在于内存Buffer大小，而且消息堆积后，性能下降不会太大，因为内存中数据多少对于对外提供的访问能力影响有限。</li><li>消息堆积到持久化存储系统中，例如<code>DB</code>，<code>KV</code>存储，文件记录形式。 当消息不能在内存<code>Cache</code>命中时，要不可避免的访问磁盘，会产生大量读IO，读IO的吞吐量直接决定了消息堆积后的访问能力。</li><li>评估消息堆积能力主要有以下四点：</li><li>消息能堆积多少条，多少字节？即消息的堆积容量。</li><li>消息堆积后，发消息的吞吐量大小，是否会受堆积影响？</li><li>消息堆积后，正常消费的<code>Consumer</code>是否会受影响？</li><li>消息堆积后，访问堆积在磁盘的消息时，吞吐量有多大？</li></ul><h2 id="rocketmq定时消息"><a class="markdownIt-Anchor" href="#rocketmq定时消息"></a> RocketMq定时消息</h2><p>定时消息是指消息发到<code>Broker</code>后，不能立刻被<code>Consumer</code>消费，要到特定的时间点或者等待特定的时间后才能被消费。</p><p>如果要支持任意的时间精度，在<code>Broker</code>层面，必须要做消息排序，如果再涉及到持久化，那么消息排序要不可避免的产生巨大性能开销。</p><p><code>RocketMQ</code>支持定时消息，但是不支持任意时间精度，支持特定的level，例如定时5s，10s，1m等。</p><p>本文转自<a target="_blank" rel="noopener" href="https://juejin.im/post/6844904008629354504">《浅入浅出》-RocketMQ</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Emil</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.hvnobug.com/post/rocketmq.html">https://blog.hvnobug.com/post/rocketmq.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.hvnobug.com" target="_blank">Emil`s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mq/">mq</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/38.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/medias/reward/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/medias/reward/wechat.png" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/medias/reward/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/medias/reward/alipay.jpg" alt="alipay"></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/hexo-script.html"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/39.png" onerror='onerror=null,src="/img/404.jpg"'><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">玩转Hexo的Scripts</div></div></a></div><div class="next-post pull-right"><a href="/post/mq.html"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/36.png" onerror='onerror=null,src="/img/404.jpg"'><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">消息队列(MQ)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/mq.html" title="消息队列(MQ)"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/36.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-22</div><div class="title">消息队列(MQ)</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/common/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__name">Emil</div><div class="author-info__description">Emil`s Blog 是 Hexo 建造的个人博客网站.Java 第三方开源框架源码. 其他语言技术分享. 个人博客搭建.</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">56</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">34</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">32</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hvnobug/" target="_blank"><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:972080809@qq.com" target="_blank"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">感谢访问本站,若喜欢请收藏 ^_^</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">RocketMQ简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E7%9A%84%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">RocketMQ的心路历程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">RocketMQ的特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E7%9A%84%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">RocketMQ的项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text">RocketMq的核心模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number">6.</span> <span class="toc-text">RocketMQ的架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nameserver"><span class="toc-number">6.1.</span> <span class="toc-text">NameServer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#producer"><span class="toc-number">6.2.</span> <span class="toc-text">Producer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#broker"><span class="toc-number">6.3.</span> <span class="toc-text">Broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consumer"><span class="toc-number">6.4.</span> <span class="toc-text">Consumer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B"><span class="toc-number">7.</span> <span class="toc-text">消息领域模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#message"><span class="toc-number">7.1.</span> <span class="toc-text">Message</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#topic"><span class="toc-number">7.2.</span> <span class="toc-text">Topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tag"><span class="toc-number">7.3.</span> <span class="toc-text">Tag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#group"><span class="toc-number">7.4.</span> <span class="toc-text">Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#queue"><span class="toc-number">7.5.</span> <span class="toc-text">Queue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#message-queue"><span class="toc-number">7.6.</span> <span class="toc-text">Message Queue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#offset"><span class="toc-number">7.7.</span> <span class="toc-text">Offset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.8.</span> <span class="toc-text">消息消费模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#message-order"><span class="toc-number">7.9.</span> <span class="toc-text">Message Order</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">8.</span> <span class="toc-text">一次完整的通信流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nameservice%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">8.1.</span> <span class="toc-text">NameService启动流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#producer-2"><span class="toc-number">8.2.</span> <span class="toc-text">Producer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#broker-2"><span class="toc-number">8.3.</span> <span class="toc-text">Broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consumer-2"><span class="toc-number">8.4.</span> <span class="toc-text">Consumer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">9.</span> <span class="toc-text">RocketMq优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E6%B6%88%E6%81%AF%E5%8E%BB%E9%87%8D"><span class="toc-number">10.</span> <span class="toc-text">RocketMq消息去重</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D"><span class="toc-number">11.</span> <span class="toc-text">RocketMq消息重复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">12.</span> <span class="toc-text">RocketMq消息的可用性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E5%88%B7%E7%9B%98%E5%AE%9E%E7%8E%B0"><span class="toc-number">13.</span> <span class="toc-text">RocketMq刷盘实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-number">14.</span> <span class="toc-text">RocketMq顺序消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">15.</span> <span class="toc-text">RocketMq分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#half-message%E5%8D%8A%E6%B6%88%E6%81%AF"><span class="toc-number">15.1.</span> <span class="toc-text">Half Message(半消息)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%9B%9E%E6%9F%A5"><span class="toc-number">15.2.</span> <span class="toc-text">消息回查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E6%B6%88%E6%81%AF%E8%BF%87%E6%BB%A4"><span class="toc-number">16.</span> <span class="toc-text">RocketMq消息过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#broker%E7%9A%84buffer%E9%97%AE%E9%A2%98"><span class="toc-number">17.</span> <span class="toc-text">Broker的Buffer问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E5%9B%9E%E6%BA%AF%E6%B6%88%E8%B4%B9"><span class="toc-number">18.</span> <span class="toc-text">RocketMq回溯消费</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E6%B6%88%E6%81%AF%E5%A0%86%E7%A7%AF"><span class="toc-number">19.</span> <span class="toc-text">RocketMq消息堆积</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rocketmq%E5%AE%9A%E6%97%B6%E6%B6%88%E6%81%AF"><span class="toc-number">20.</span> <span class="toc-text">RocketMq定时消息</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/concurrent-phaser.html" title="并发编程 - Phaser"><img data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/58.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="并发编程 - Phaser"></a><div class="content"><a class="title" href="/post/concurrent-phaser.html" title="并发编程 - Phaser">并发编程 - Phaser</a><time datetime="2021-04-07T14:13:12.000Z" title="发表于 2021-04-07 22:13:12">2021-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/concurrent-semaphore.html" title="并发编程 - Semaphore"><img data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/57.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="并发编程 - Semaphore"></a><div class="content"><a class="title" href="/post/concurrent-semaphore.html" title="并发编程 - Semaphore">并发编程 - Semaphore</a><time datetime="2021-04-03T05:33:27.000Z" title="发表于 2021-04-03 13:33:27">2021-04-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/concurrent-cyclicbarrier.html" title="并发编程 - CyclicBarrier"><img data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/56.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="并发编程 - CyclicBarrier"></a><div class="content"><a class="title" href="/post/concurrent-cyclicbarrier.html" title="并发编程 - CyclicBarrier">并发编程 - CyclicBarrier</a><time datetime="2021-03-27T02:23:57.000Z" title="发表于 2021-03-27 10:23:57">2021-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/concurrent-countdownlatch.html" title="并发编程 - CountDownLatch"><img data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/54.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="并发编程 - CountDownLatch"></a><div class="content"><a class="title" href="/post/concurrent-countdownlatch.html" title="并发编程 - CountDownLatch">并发编程 - CountDownLatch</a><time datetime="2021-03-20T12:13:12.000Z" title="发表于 2021-03-20 20:13:12">2021-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/concurrent-reentrantreadwritelock.html" title="并发编程 - ReentrantReadWriteLock"><img data-lazy-src="https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/54.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="并发编程 - ReentrantReadWriteLock"></a><div class="content"><a class="title" href="/post/concurrent-reentrantreadwritelock.html" title="并发编程 - ReentrantReadWriteLock">并发编程 - ReentrantReadWriteLock</a><time datetime="2021-03-12T05:21:53.000Z" title="发表于 2021-03-12 13:21:53">2021-03-12</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://cdn.jsdelivr.net/gh/hvnobug/assets/blog/album/original-anime/0.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Emil</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49b1f5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'wN7GK2Jgd6fz8so4U85XeUxl-9Nh9j0Va',
      appKey: 'JRpha8sPFNqXkv1a0HNIIQFY',
      placeholder: '说点什么吧 ...!',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>✨ 网站已更新最新版本 👉</label> <a href="javascript:void(0)" onclick="location.reload()">點擊刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"點擊刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",function(){showNotification()}),window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")}));</script><script src="//code.tidio.co/aksnqalq4y8zibuahby7nqeilrtcb1oi.js" async></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()</script></div><link href="//unpkg.com/aplayer/dist/APlayer.min.css" rel="stylesheet"><script src="//cdn.jsdelivr.net/npm/hls.js@latest"></script><script src="//unpkg.com/aplayer/dist/APlayer.min.js"></script><script src="/assets/aplayer.js" type="text/javascript"></script><script type="text/javascript">const $title = $('.bg-cover .title');
    if ($title.length > 0) {
        $.ajax({
            url: 'https://sdk.jinrishici.com/v2/browser/jinrishici.js',
            dataType: "script",
            cache: true,
            async: false,
            success: function () {
                jinrishici.load(function (result) {
                    // 自己的处理逻辑
                    const {status, data} = result;
                    if (status === 'success') {
                        $title.css('font-size', '3rem');
                        $title.html(data.origin.title + '<span style="font-size:2rem;margin-left:1rem;">' + data.origin.author + '-' + data.origin['dynasty'] + '</span>');
                        typed.strings = data.origin.content.slice(0, 2);
                    }
                });
            }
        });
    }</script><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>✨ 网站已更新最新版本 👉</label> <a href="javascript:void(0)" onclick="location.reload()">點擊刷新</a></div></div><script>function showNotification(){var t,e,o;GLOBAL_CONFIG.Snackbar?(t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position,Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})):(o="top: 0; background: "+("light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f")+";",document.getElementById("app-refresh").style.cssText=o)}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",function(){showNotification()}),window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")}))</script><script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script><script>const hasAttr = (e,a) => a.some(_=> e.attr(_)!==undefined);
        $('a').each(function() {
          const $this = $(this);
          if(hasAttr($this,["data-fancybox","ignore-external-link"])) return;
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== '' || window.location.host) {
                    $this.attr('href', '/go.html?url='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });</script></body></html>